version: "3.9"

# Phase 2 – Simplified Stack (Prototype Mode)
# 2 services: api (GPU) + nginx (reverse proxy + static files)
# Redis and Celery worker removed — pipeline is now synchronous

services:

  # ── FastAPI + GPU inference ────────────────────────────────
  api:
    build: .
    restart: unless-stopped
    environment:
      - DEVICE=cuda
      - USE_FP16=true
      - USE_XFORMERS=true
      - USE_REFINER=true
      - REFINER_STRENGTH=0.2
      - FACE_MASK_PADDING=30
      - IP_ADAPTER_SCALE=0.7
      - FACE_IDENTITY_ENABLED=true
    env_file: .env
    ports:
      - "8000:8000"
    volumes:
      - model_cache:/app/model_cache
      - /tmp/tryon:/tmp/tryon
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [ gpu ]

  # ── Nginx – static frontend + API proxy ────────────────────
  nginx:
    image: nginx:alpine
    restart: unless-stopped
    depends_on:
      - api
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./frontend:/usr/share/nginx/html:ro

volumes:
  model_cache:
    driver: local

# To re-enable Celery + Redis for production scaling:
#   1. Add redis service (image: redis:7-alpine)
#   2. Add worker service (command: celery -A app.queue.worker.celery_app worker)
#   3. Set REDIS_URL in .env
#   4. Switch routers/tryon.py back to async enqueue pattern
